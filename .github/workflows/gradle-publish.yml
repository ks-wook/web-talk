name: Deploy Spring Boot to EC2

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # 1. 소스 체크아웃
      # =========================
      - name: Checkout
        uses: actions/checkout@v4

      # =========================
      # 2. AWS 인증 설정
      # =========================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2


      # =========================
      # 3. Docker ARM64 빌드
      # =========================
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (ARM64)
        run: |
          docker buildx build \
            --platform linux/arm64 \
            -t ${{ secrets.DOCKER_IMAGE_NAME }}:latest \
            --load .

      # =========================
      # 4. ECR Push
      # =========================
      - name: Tag & Push Docker image to ECR
        run: |
          docker tag \
            ${{ secrets.DOCKER_IMAGE_NAME }}:latest \
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.DOCKER_IMAGE_NAME }}:latest

          docker push \
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.DOCKER_IMAGE_NAME }}:latest



      # =========================
      # 5. ALB Target Group Rolling Deploy
      # =========================
      - name: Rolling Deploy via ALB Target Group (Final)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail
      
            chmod 600 /home/ec2-user/web-talk-private-key.pem
      
            # Instance ID : Private IP 매핑
            INSTANCES=(
              "${{ secrets.PRIVATE_EC2_ID_1 }}:${{ secrets.PRIVATE_EC2_IP_1 }}"
              "${{ secrets.PRIVATE_EC2_ID_2 }}:${{ secrets.PRIVATE_EC2_IP_2 }}"
            )
      
            for ENTRY in "${INSTANCES[@]}"
            do
              INSTANCE_ID="${ENTRY%%:*}"
              INSTANCE_IP="${ENTRY##*:}"
      
              echo "========================================"
              echo "Rolling deploy start"
              echo "Instance ID : $INSTANCE_ID"
              echo "Instance IP : $INSTANCE_IP"
              echo "========================================"
      
              # 1️⃣ Target Group에서 제외
              aws elbv2 deregister-targets \
                --target-group-arn ${{ secrets.TARGET_GROUP_ARN }} \
                --targets Id=$INSTANCE_ID,Port=${{ secrets.DOCKER_CONTAINERPORT }}
      
              echo "Waiting for connection draining..."
              sleep 40
      
              # 2️⃣ Private EC2에 배포
              ssh -i /home/ec2-user/web-talk-private-key.pem \
                -o StrictHostKeyChecking=no \
                ec2-user@$INSTANCE_IP "
                  set -euo pipefail
      
                  echo '[INFO] Login to ECR'
                  aws ecr get-login-password --region ${{ secrets.AWS_REGION }} \
                  | docker login --username AWS --password-stdin \
                    ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
      
                  echo '[INFO] Stop & remove existing container'
                  docker stop ${{ secrets.DOCKER_CONTAINERNAME }} || true
                  docker rm   ${{ secrets.DOCKER_CONTAINERNAME }} || true
      
                  echo '[INFO] Cleanup dangling images'
                  docker image prune -f
      
                  echo '[INFO] Pull new image'
                  docker pull \
                    ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.DOCKER_IMAGE_NAME }}:latest
      
                  echo '[INFO] Run new container'
                  docker run -d \
                    --name ${{ secrets.DOCKER_CONTAINERNAME }} \
                    --env-file /opt/${{ secrets.DOCKER_IMAGE_NAME }}/dev.env \
                    -e SPRING_PROFILES_ACTIVE=docker \
                    -p 7002:7002 \
                    -v /var/log/app:/var/log/app \
                    --restart always \
                    ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.DOCKER_IMAGE_NAME }}:latest
                "
                
      
              # 3️⃣ Target Group 재등록 (중요)
              aws elbv2 register-targets \
                --target-group-arn ${{ secrets.TARGET_GROUP_ARN }} \
                --targets Id=$INSTANCE_ID,Port=${{ secrets.DOCKER_CONTAINERPORT }}
      
              # 4️⃣ 헬스 체크 대기
              echo "Waiting for target to become healthy..."
              
              MAX_WAIT=300
              INTERVAL=10
              ELAPSED=0
              
              HEALTHY_COUNT=0
              UNHEALTHY_COUNT=0
              
              REQUIRED_HEALTHY=3
              MAX_UNHEALTHY=5
              
              while true
              do
                STATE=$(aws elbv2 describe-target-health \
                  --target-group-arn ${{ secrets.TARGET_GROUP_ARN }} \
                  --targets Id=$INSTANCE_ID,Port=${{ secrets.DOCKER_CONTAINERPORT }} \
                  --query 'TargetHealthDescriptions[0].TargetHealth.State' \
                  --output text)
              
                echo "Current target state: $STATE"
              
                case "$STATE" in
                  healthy)
                    HEALTHY_COUNT=$((HEALTHY_COUNT + 1))
                    UNHEALTHY_COUNT=0
                    echo "Healthy count: $HEALTHY_COUNT/$REQUIRED_HEALTHY"
              
                    if [ "$HEALTHY_COUNT" -ge "$REQUIRED_HEALTHY" ]; then
                      echo "Target is stable healthy"
                      break
                    fi
                    ;;
                  unhealthy)
                    UNHEALTHY_COUNT=$((UNHEALTHY_COUNT + 1))
                    HEALTHY_COUNT=0
                    echo "Unhealthy count: $UNHEALTHY_COUNT/$MAX_UNHEALTHY"
              
                    if [ "$UNHEALTHY_COUNT" -ge "$MAX_UNHEALTHY" ]; then
                      echo "Target consistently unhealthy"
                      exit 1
                    fi
                    ;;
                  *)
                    echo "Target state is $STATE (waiting)"
                    HEALTHY_COUNT=0
                    UNHEALTHY_COUNT=0
                    ;;
                esac
              
                if [ "$ELAPSED" -ge "$MAX_WAIT" ]; then
                  echo "Health check timeout"
                  exit 1
                fi
              
                sleep $INTERVAL
                ELAPSED=$((ELAPSED + INTERVAL))
              done
      
              echo "===== Rolling deploy completed: $INSTANCE_ID ====="
            done

